## 常规首部部分

网络层的分组称为数据报 `datagram`。

数据报两个部分组成：首部和数据。首部长度可以是 20~60 字节，包含有关路由选择和交付的重要信息。

IP 数据报的首部格式如下。
![](../LocalFile/Picture/IP数据报首部格式.png)
### 版本 `VER`
定义个 IP 协议的版本。目前的版本是 4，但是将来的版本 6 可能会取代版本 4。

### 首部长度 `HLEN`
定义了数据报首部的长度，以 4 字节为单位计算。

### 服务类型 `type of service, TOS`
现在大多数 TCP/IP 实现都不支持 `TOS` 特性，一般设置全零。

### 总长度
定义了以字节为单位的数据报总长度（首部加上数据）。因为总长度的字段是 16 位，因此 IP 数据报长度限制在 65535 字节，其中首部占 20~60 字节，剩下的是从上层传送过来的数据。

大部分情况下并不需要总长度字段，因为帧剥去帧首部和尾部之后剩下的就是 IP 数据报了。但是有些情况下，封装在帧里面的并不仅仅是数据报，还可能添加了一些填充。例如，以太网协议对帧里的数据有最小值和最大值的限制（46~1500 字节）。当 IP 数据报的长度小于 46 字节时，需要增加一些填充字节才能满足这个要求。在这种情况下，接收帧的机器必须检查总长度字段才能确定数据的真正长度和填充字节的长度。

### 标识 

>IP 数据报的最大长度为 65535 字节。由于数据报可能会经过不同的网络，如果网络的 MTU 小于数据报的大小，那么为了让数据报通过网络就要分割数据报。
>
>源点通常不会对 IP 数据吧进行分片。因为运输层会把数据划分成 IP 与源点使用的数据链路层可接纳的大小。
>
>当数据报被分片时，首部中的一些必要的部分必须被复制到所有的分片中。对数据报进行分片的主机或路由器必须改变的三个字段的值：标志、分片偏移和总长度。其余的个字段必须被复制。
>
>当然，不管是否进行分片，校验和的值总是要重新计算的。因为数据报每经过一跳，TTL 的值都会发生改变。

该字段标志了从源主机发出的一个数据报。当数据报从源主机离开之后，标识字段与源 IP 地址的组合唯一地确定了这个数据报。

IP 协议使用了一个计数器来为数据报生成标识，初始值为正整数。当 IP 协议每发送一个数据报时，就把这个计数器的当前值复制到标识字段中，并把计数器的值加 1。

在数据报分片时，标识字段的值要复制到所有的分片中。所有的分片都具有相同的标识，这个标识在终点重装数据报时很有用。

### 标志
这是 3 位的字段。

第一位保留。

第二位称为 “不分片”，`Don't Fragment，DF` 位。

如果值是 1，机器就不能对该数据报进行分片。如果不分片不能通过该物理网络，就丢弃这个数据报，并向源主机发送 ICMP 报文（终点不可达报文，代码 4）。

如果值是 0，则可在必要时对这个数据报进行分片。

第三位是 “还有分片” 位，1 表示这个数据报不是最后的分片，在这个分片后还有更多的分片；0 表示这是最后的或唯一的分片。

### 分片偏移
这个 13 位的字段表示的是分片在整个数据报中的相对位置，即数据在原始数据报中的偏移量，以 8 字节为度量单位。

例如，一个有 4000 字节数据的数据报被划分为三个分片，0~3999 字节的数据是第一个分片，1400~2799 为第二个分片，2800~3999 为第三个分片，那么三个分片的分片偏移字段值为：0/8=0，1400/8=175，2800/8=350。

所有的分片的标识字段值都是一样的。除最后一个分片外，所有分片的标志字段的 “还有分片” 位均被置 1。
![](../LocalFile/Picture/详细分分片示例.png)
上图描绘了如果分片还有分片时的情况，分片偏移值永远是相对原始数据报的。

即使分片采用不同的路径并失序到达，最终的目的主机也能够用收到的分片（假设没有一个丢失）重装成原始的数据报，使用的策略如下：
```
1. 第一个分片的分片偏移字段值为 0。

2. 把第一个分片的长度除以 8，这个结果就是第二个分片的分片偏移值。

3. 把第一个和第二个分片的数据总长度除以 8，这个结果就是第三个分片的分片偏移值。

4. 继续以上过程。最后一个分片的 “还有分片” 位的值是 0。
```

### 生存时间 `time-to-live，TTL`
该字段设置了数据报可以经过的最多路由器数。它指定了数据报的生存时间。`TTL` 的初始值由源主机设置（通常为 32 或 64），一旦经过一个处理它的路由器，它的值就减去 1。当该字段的值为 0 时，数据报就被丢弃。并发送 ICMP 报文（类型为超时）通知源主机。

### 协议
定义了使用此 IP 层服务的高层协议（不一是运输层，也可能是网络层的其它协议）。
```
| 1   - ICMP 
| 2   - IGMP 
| 6   - TCP  
| 17  - UDP 
| 89  - OSPF 
```

### 校验和
校验和能够防止分组在传输期间出现损坏。发送端计算校验和，并把得到的结果与分组一起发送出去。

IP 分组中的校验和仅覆盖首部，而不管数据。两个原因，首先，将数据封装在 IP 数据包中的所有高层协议都有一个涉及整合分组的校验和字段。因此，IP 数据报的校验和就不必再检验所封装的数据。其次，每经过一个路由器，IP 数据报的首部都要发生变化，但数据部分保持不变。因此校验和只对发生变化的部分进行检验。

!!! note "IP 协议主要是为了路由和转发数据包，至于端到端的数据完整性校验交由上层的协议处理。"

发送方按照以下步骤计算：

	1.把校验和字段置为零。

	2.计算所有 16 位字（首部）之和。

	3.把得到的和求反码存储在校验和字段中。

接收方按照以下步骤检验：

	1.计算所有 16 位字（首部）之和。

	2.把得到的和求反码。

	3.如果步骤 2 得到的结果是零，则接受这个报文，否则丢弃。

>校验和的目标是检测数据在传输过程中是否发生了错误，但并非绝对能够检测所有错误。校验和使用了一种简单的算法，通常是二进制的累加和，以便快速计算和检测传输数据的变化。
>
>校验和的作用是检测传输过程中是否发生了单一比特的错误，例如由于噪声引起的比特翻转。它能够有效地捕获这种类型的错误，但并不总是能够检测更复杂的错误，比如多个比特同时发生变化或某些特定模式的错误。

### 源地址
定义的源点的地址，一般（不考虑 NAT 或者其它情况）情况下在 IP 数据报从源主机发送到目的主机的过程中保持不变。

### 目的地址
定义了终点的 IP 地址，一般（不考虑 NAT 或者其它情况）情况下在 IP 数据报从源主机发送到目的主机的过程中保持不变。

## 首部选项部分

IP 数据报的首部由两个部分组成，固定部分和可变部分。固定部分的长度是 20 字节，可变部分由一些选项组成，最长可达 40 字节。

选项部分对每个数据报来说并不是必须的，这些选项可用于网络的测试和排错。

下图是选项的格式，三个组成部分：一个字节的类型字段，一个字节的长度字段，以及可变长度的值字段。这三个字段被称为 `type-length-value，TLV`。
![](../LocalFile/Picture/选项的格式.png)
### 类型
类型字段 `type field` 的长度为 8 位，包括了三个子字段：复制、类别和编号。

- **复制** 这个 1 位子字段控制了选项在分片中的出现。若这个值是 0，就表示必须仅仅复制到第一个分片。若这个值是 1，则表示选项必须复制到所有分片中。

- **类别** 这个 2 位子字段定义了该选项的一般用途。

- **编号** 这个 5 位字段定义了选项的类型。目前仅定义了 6 种类型。其中两种为单字节选项（无操作和选项结束），不需要长度和值字段；剩下的四种是多字节选项，需要长度和值字段。

**无操作选项 no-operation option** 是个 1 字节的选项，用作选项和选项之间的填充符。

**选项结束选项 end-of-operation option** 也是一个 1 字节的选项，用于选项字段结束时的填充。

选项结束选项只能用于最后一个选项，并且只能使用一次。在这个选项之后，接收器就开始寻找净荷数据。这就表示如果对齐选项需要超过一个字节，那么必须使用一些无操作选项，然后再跟随一个选项结束选项。

**记录路由选项 record-route option** 用来记录处理数据报的因特网路由器。它可以列出最多 9 个路由器的 IP 地址，因为首部的最大长度是 60 字节，其中还包括 20 字节的基本首部，还剩 40 字节留给选项部分。
![](../LocalFile/Picture/记录路由选项.png)
指针字段是一个偏移量的整数字段，它指向第一个可用的空项。源点在选项的值字段中创建了一些用于填写 IP 地址的空字段。当数据报离开源点时，所有这些字段都是空的。指针字段的值是 4，指向第一个空字段。

下图是在 192.168.31.14 机器执行 ping -R 192.168.31.1 命令发出的第一个 echo-request 包。
![](../LocalFile/Picture/PastedImage20240305225924.png)

Options: (40 bytes), Record Route 表示 IP 数据报包含了 40 字节的选项部分。

第一个选项是单字节的无操作选项，用来填充对齐。

第二个选项是记录路由选项，共 39 个字节。

- 类型占一个字节，复制、类别和编号分别是 0、00 和 00111。

- 长度占一个字节，表示该选项共 39 个字节。

- 指针占一个字节，指向下一个可用选项，第 8 个字节。前面七个字节被类型、长度、指针本身和本机的 IP 地址占用了。

- 第一个路由选项记录的是发出请求的机器的 IP，即 192.168.31.14，占用 4 个字节。

- 选项的其余部分被初始化位空，全 0。

下图是上面一个 echo-request 对应的 echo-reply 包。
![[Pasted image 20240305230906.png]]
Options: (40 bytes), Record Route 表示 IP 数据报包含了 40 字节的选项部分。

第一个选项是记录路由选项，共 39 个字节。

- 类型占一个字节，复制、类别和编号分别是 0、00 和 00111。

- 长度占一个字节，表示该选项共 39 个字节。

- 指针占一个字节，指向下一个可用选项，第 16 个字节。

- 可以看到选项记录里面增加了两条 192.168.31.1，可能是接收 IP 数据报的时候增加了一条，发出 IP 数据报的时候又增加了一条。

第二个选项是单字节的选项结束选项，用来填充对齐。

严格源路由选项（strict-source-route option）被源点用来预先指定数据报在因特网中传送时的路由。

如果数据报指定了严格路由选项，那么这个数据报就必须经过在选项中定义的所有路由器。

若某路由器的 IP 地址未被列入到数据报中，则这个数据报就一定不能通过这个路由器。

若数据报达到了一个未被列入的路由器，则路由器将丢弃该数据报并发送差错报文。

若数据报达到终点时仍有某些列入的路由器未曾经过，则终点把这个数据报丢弃并发出差错报文。

对于某些场景来说该选项是有用的，比如发送方可以选择最小时延或最大吞吐的路由。或者出于安全考虑，发送方可以选择某条路由使得数据报不经过竞争对手的网络。

不严格源路由选项（loose-source-route option）与严格路由选项相似，但条件要放宽一些。

表中列出的路由器必须通过，但是数据还以访问其他的路由器。


**长度** 长度字段（length field）定义了选项的总长度，包括类型字段和长度字段本身。这个字段并不是在所有类型的选项中都会出现。

**值** 值字段（value field）包含的是某些特定选项所需的数据。这个字段并不是在所有类型的选项中都会出现。


