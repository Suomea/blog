参考链接：https://linux.vbird.org/linux_server/rocky9/0130vmtuning.php
## 环境安装
执行以下命令安装KVM、libvirt守护进程、以及桥接网络工具 。
```
apt install -y qemu-kvm libvirt-daemon-system  bridge-utils
```

libvirt-daemon-system 会默认创建 NAT 网络，如果没有启动的话需要手动启动：
```
virsh net-list --all
virsh net-start default
virsh net-autostart default
```

默认新增的配置：
```
# iptables -L -n -v --line-numbers
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        0     0 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:53
2        0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:53
3        0     0 ACCEPT     udp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            udp dpt:67
4        0     0 ACCEPT     tcp  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:67

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        0     0 ACCEPT     all  --  *      virbr0  0.0.0.0/0            192.168.122.0/24     ctstate RELATED,ESTABLISHED
2        0     0 ACCEPT     all  --  virbr0 *       192.168.122.0/24     0.0.0.0/0           
3        0     0 ACCEPT     all  --  virbr0 virbr0  0.0.0.0/0            0.0.0.0/0           
4        0     0 REJECT     all  --  *      virbr0  0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable
5        0     0 REJECT     all  --  virbr0 *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable

Chain OUTPUT (policy ACCEPT 10063 packets, 2716K bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        0     0 ACCEPT     udp  --  *      virbr0  0.0.0.0/0            0.0.0.0/0            udp dpt:68

```

安装Cockpit及其虚拟机管理插件 。
```
apt install -y cockpit cockpit-machines
```

将您的管理用户加入`libvirt`和`kvm`用户组，这样您就可以通过Cockpit或`virt-manager`管理虚拟机，而无需为每个操作都输入密码 。
```
sudo usermod -aG libvirt,kvm $LOGNAME
```


## 磁盘存储池
查询存储池列表
```
# 列出所有存储池 
virsh pool-list --all 

# 查看存储池详细信息
virsh pool-info vm_pool 

# 检查存储池XML定义
virsh pool-dumpxml vm_pool

# 停用存储池
virsh pool-destroy vm_pool

# 删除存储池定义
virsh pool-undefine vm_pool

# 刷新存储池（检测新存储卷）
virsh pool-refresh vm_pool
```

使用物理磁盘创建存储池
```
# 清除分区表和文件系统签名
wipefs -a /dev/sdb

# 创建一个存储池 
virsh pool-define-as vm_pool disk --source-dev /dev/sdb --target /var/lib/libvirt/images/vm_pool 
virsh pool-define-as vm_pool dir --target /data/disk1 
virsh pool-build vm_pool 
virsh pool-start vm_pool 
virsh pool-autostart vm_pool
```

##  卷的常见格式

| 格式            | 特点           | 适用场景         |
| ------------- | ------------ | ------------ |
| ​**​raw​**​   | 原始格式，性能最好    | 高性能需求        |
| ​**​qcow2​**​ | 支持快照、压缩、加密   | 通用虚拟化        |
| ​**​vmdk​**​  | VMware兼容格式   | 跨平台迁移        |
| ​**​vdi​**​   | VirtualBox格式 | VirtualBox环境 |

创建卷
```
virsh vol-create-as vm_pool myvm.qcow2 20G --format qcow2
```

查询卷信息
```
# 列出存储池中的所有卷
virsh vol-list vm_pool

# 查看卷详细信息
virsh vol-info --pool vm_pool myvm.qcow2

# 查看卷路径（用于虚拟机配置）
virsh vol-path --pool vm_pool myvm.qcow2
```

调整卷大小
```
# 将卷扩展到30GB
virsh vol-resize --pool vm_pool myvm.qcow2 30G

# 注意：扩展后需要在虚拟机内扩展文件系统
```
