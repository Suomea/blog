## PAM 介绍
**​PAM​**​（​**​Pluggable Authentication Modules​**​，可插拔认证模块）是 ​**​Linux/Unix 系统中的一个核心安全框架​**​，用于统一管理各类应用程序的认证机制。它通过模块化设计，允许系统管理员灵活配置身份验证、授权、密码策略等功能，而无需修改应用程序代码。

应用程序，libpam.so 框架 API，具体的 so 库为具体的实现。

查看安装的库
```
find /lib /usr/lib -name 'pam_*.so'
```

PAM 的配置位于 `/etc/pam.d/`目录，每个服务（如 `sshd`、`sudo`）有独立的配置文件。

工作流程，当执行 passwd 之后：
1. 执行 passwd 这个程序，并输入密码。
2. passwd 会调用 PAM 模块进行验证。
3. PAM 会找到 /etc/pam.d/passwd 配置文件，可能是 passwd 调用接口的时候传的配置文件路径。
4. PAM 模块就会解析配置文件，根据配置文件的设定进行验证分析。
5. 将验证结果（成功，失败）回传给 passwd。
6. passwd 获取结果之后，决定下一个动作。

​**​文件示例​**​：/etc/pam.d/passwd
```
# 可以看出可以引用其他的配置文件
@include common-password

# /etc/pam.d/common-password
password        requisite                       pam_pwquality.so retry=3 minlen=8 ucredit=-1 lcredit=-1 dcredit=-1
password        [success=1 default=ignore]      pam_unix.so obscure use_authtok try_first_pass sha512
password        requisite                       pam_deny.so
password        required                        pam_permit.so

```
​
具体的每行配置
第一个字段：验证类别
- auth 认证，主要用来检验使用者的身份。
- account 账号，主要进行授权时检验是或否有正确的权限。
- session 会话。
- passwd 密码，密码的修改变更使用。

第二个字段：控制标识
- required 验证成功 success 或者验证失败 failure，都会继续后续的验证流程。
- requisite 失败 failure 立刻返回原程序，并终止后续验证流程。成功 success 继续后续的流程。
- sufficient 成功 success 立刻返回原程序，并终止后续验证流程。失败 failure 继续后续的流程。
- optional 显示讯息，不使用在验证方面的。

第三个字段：调用的 PAM 模块。

第四个字段：调用 PAM 模块的参数。

主要通过 PAM 来满足上述要求。

## 密码强度 libpam-pwquality
安装密码策略强化模块：
```
apt install libpam-pwquality
```

编辑配置文件
```
# 编辑配置文件 /etc/pam.d/common-password，确保存在下面的行
password requisite pam_pwquality.so retry=3 

# 编辑配置文件 /etc/security/pwquality.conf，设置密码复杂度策略
minlen = 8  # 至少 8 位
dcredit = -1  # 至少 1 个数字
ucredit = -1  # 至少 1 个大写字母
ocredit = -1  # 至少 1 个特殊字符
enforce_for_root  # root 用户也要遵守这个规则
```


## 密码有效期配置
```
# /etc/login.defs
PASS_MAX_DAYS 90 # 密码最长使用 90 天 
PASS_MIN_DAYS 7 # 密码最短 7 天内不能修改 
PASS_WARN_AGE 14 # 密码过期前 14 天开始提醒用户
```

修改配置文件支队新用户生效，现有用户需要手动更改。
```
# 密码 90 天有效，7 天内不能修改密码，到期之前 14 天提醒，过期之后宽限 14 天
chage -M 90 -m 7 -W 14 -I 14 jacky
chage -l jacky
```

## 登录失败锁定 libpam-faillock
查看 ssh 日志
```
journalctl -u ssh -f
```

**PAM 锁定**
安装模块
```
apt install libpam-faillock
```

配置
```
# 查看有没有已经配置过了
grep pam_faillock /etc/pam.d/*

# 编辑配置文件进行配置 /etc/pam.d/common-auth
auth required pam_faillock.so preauth audit silent deny=2 unlock_time=600 
auth required pam_faillock.so authfail audit deny=2 unlock_time=600

- preauth 在用户输入密码之前，检查状态。先检查，进入 preauth 阶段，然后可以多次输入密码（多次重复进入 auth）。 
- audit 启用审计功能。
- silent 静默模式，不向用户展示失败次数。
- unlock_time 锁定秒数。
  

# 查看所用用户
faillock

# 查看特定用户
faillock --user jacky

# 手动解锁
faillock --user jacky --reset
```

## 登录失败锁定 fail2ban 锁定
pam 是基于账号的锁定，可以进一步使用 fail2ban 进行网络层的封禁处理（基于 IP 地址）。

安装
```
apt install fail2ban
```

配置
```
# 编辑配置文件 /etc/fail2ban/jail.local
[sshd]
enabled  = true
port     = ssh
filter   = sshd
logpath  = /var/log/auth.log
findtime = 600      # 在 600 秒内
maxretry = 3        # 3 次登录失败
bantime  = 600      # 锁定 600 秒
```

查看状态
```
fail2ban-client status sshd
```


4. 会话超时自动退出
```
# 编辑配置文件 /etc/profile，配置 900 秒自动退出会话
export TMOUT=900
```

参考连接
https://manpages.debian.org/unstable/libpam-modules/pam_faillock.8.en.html
https://linuxconfig.org/lock-account-after-failed-logins-on-debian-ubuntu
