## 身份鉴别
### PAM 介绍
**​PAM​**​（​**​Pluggable Authentication Modules​**​，可插拔认证模块）是 ​**​Linux/Unix 系统中的一个核心安全框架​**​，用于统一管理各类应用程序的认证机制。它通过模块化设计，允许系统管理员灵活配置身份验证、授权、密码策略等功能，而无需修改应用程序代码。

`libpam.so` 是 PAM 框架的核心库，提供了应用程序与 PAM 模块交互的接口。
然后具体的 PAM 模块实现了不同的业务逻辑功能。
应用程序通过 PAM 提供的 API 与具体的 PAM 模块进行交互。

查看安装的库：
```
find /lib /usr/lib -name 'pam_*.so'
```

PAM 的配置位于 `/etc/pam.d/`目录，每个服务（如 `sshd`、`sudo`）有独立的配置文件。

工作流程，当执行 `passwd` 指令之后：

1. 执行 `passwd` 这个程序，并输入密码。
2. `passwd` 会调用 PAM 模块进行验证。
3. PAM 会找到 `/etc/pam.d/passwd` 配置文件（配置文件的路径可能是 `passwd` 调用方法的时候传的配置文件路径）。
4. 解析配置文件，根据配置文件的设定进行验证分析。
5. 将验证结果（成功，失败）回传给 `passwd`。
6. `passwd` 获取结果之后，决定下一个动作。

​配置文件示例​​：
```
# /etc/pam.d/passwd 可以看出可以引用其他的配置文件
@include common-password

# /etc/pam.d/common-password
password        requisite                       pam_pwquality.so retry=3 minlen=8 ucredit=-1 lcredit=-1 dcredit=-1
password        [success=1 default=ignore]      pam_unix.so obscure use_authtok try_first_pass sha512
password        requisite                       pam_deny.so
password        required                        pam_permit.so

```
​
具体的每行配置
第一个字段：验证类别

- auth 认证，主要用来检验使用者的身份。
- account 账号，主要进行授权时检验是或否有正确的权限。
- session 会话。
- passwd 密码，密码的修改变更使用。

第二个字段：控制标识

- required 验证成功 success 或者验证失败 failure，都会继续后续的验证流程。
- requisite 失败 failure 立刻返回原程序，并终止后续验证流程。成功 success 继续后续的流程。
- sufficient 成功 success 立刻返回原程序，并终止后续验证流程。失败 failure 继续后续的流程。
- optional 显示讯息，不使用在验证方面的。

第三个字段：调用的 PAM 模块。

第四个字段：调用 PAM 模块的参数。
### 密码强度配置 
密码强度校验模块：libpam-pwquality

编辑配置文件：
```
# 查看有没有已经配置过了
grep pam-pwquality /etc/pam.d/*

# 编辑配置文件 /etc/pam.d/common-password，确保存在下面的行
password requisite pam_pwquality.so retry=3 

# 编辑配置文件 /etc/security/pwquality.conf，设置密码复杂度策略
minlen = 8  # 至少 8 位
dcredit = -1  # 至少 1 个数字
ucredit = -1  # 至少 1 个大写字母
ocredit = -1  # 至少 1 个特殊字符
enforce_for_root  # root 用户也要遵守这个规则
```
### 密码有效期配置
修改配置文件：
```
# /etc/login.defs
PASS_MAX_DAYS 90 # 密码最长使用 90 天 
PASS_MIN_DAYS 7 # 密码最短 7 天内不能修改 
PASS_WARN_AGE 14 # 密码过期前 14 天开始提醒用户
```

修改配置文件只对新添加用户生效，系统现有用户需要手动更改。
```
# 密码 90 天有效，7 天内不能修改密码，到期之前 14 天提醒，过期之后宽限 14 天
chage -M 90 -m 7 -W 14 -I 14 jacky
chage -l jacky
```

### 登录失败锁定账号 
登录失败锁定模块：libpam-faillock

faillock 有三个选项：

- preauth 需要在认证之前调用，检查账号是否锁定，锁定直接结束。
- authfail 需要在认证失败之后调用，记录失败次数。
- authsucc 需要在认证成功之后调用，用来清除失败的记录，否则 faillock 无法区分连续和非连续的认证失败，导致误锁。

配置：
```
# 查看有没有已经配置过了
grep pam_faillock /etc/pam.d/*

# 编辑配置文件，配置 faillock 参数 /etc/security/faillock.conf
# 生成审计日志；不提示账号已经被锁定；连续失败 3 次；在 900 秒的时间窗口内；
# 锁定 600 秒；上述规则对 root 用户也生效（保留 public key 认证方式，防止登录不进系统）。
audit
silent
deny = 3
fail_interval = 900
unlock_time = 600
even_deny_root


# 编辑配置文件进行配置 /etc/pam.d/common-auth，这里也可以指定参数，这里的优先级更高
# requisite 失败不进行后续的流程，preauth 检查失败次数，如果达到阈值直接终止流程，否则继续
auth    requisite                       pam_faillock.so preauth
# success=1 表示成功之后跳过后面的 1 条认证流程
auth    [success=1 default=bad]      pam_unix.so nullok
# 如果能执行到这一行，表示认证已经失败，记录失败次数，default=die 终止流程，如果认证成功会跳过
auth    [default=die]                   pam_faillock.so authfail   
# 如果能执行到这一行，表示已经认证成功，清除失败的记录，然后返回
auth    sufficient                      pam_faillock.so authsucc
auth    requisite                       pam_deny.so
auth    required                        pam_permit.so

  

# 查看所用用户
faillock

# 查看特定用户
faillock --user jacky

# 手动解锁
faillock --user jacky --reset
```
### 会话超时自动退出
```
# 编辑配置文件 /etc/profile，配置 900 秒自动退出会话
export TMOUT=900
```
## 安全审计
审计服务可以记录谁在什么时间做了什么操作，影响了哪些文件。
```
apt install auditd
dpkg -L auditd
```

auditd 核心守护进程。
auditctl 用户空间命令，用于添加或删除审计规则。
ausearch 查询审计日志。
aureport 将日志整理为可读报表。

审计日志的格式

默认记录哪些事件，如何查询？ausearch 有哪些参数

审计日志保存多久，如何配置？要至少保存 90 天

添加监控文件的规则
```
auditctl -w /root/a.txt -p rwxa -k watch_a
```

-w 监控文件的路径
-p rwxa 监控文件的读、写、执行、属性变更。
-k 添加标签，方便搜索。

查看添加的规则
```
auditctl -l
```

查询日志
```
ausearch -k watch_a
```

日志生成报告
```
ausearch -k watch_a | aureport -f
```



