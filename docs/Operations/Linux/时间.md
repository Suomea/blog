#ntp #Linux 
# 时钟和时区

地球一圈是 360 度角，共划分为 24 和时区，一个时区就是 15 度角。

### GMT

格林威治时间（Greewich Mean Time，GMT 时间）标准，是基于太阳通过格林威治天文台子午线的平均位置来定义的，是一个天文学上的概念。

在 1880 年代之前的时间标准是以 GMT 时间为主，然而地球的自转轨道一个公转轨道并非正圆，加上地球的自转速度有逐年减少的问题，导致有精度问题。

### UTC

UTC（Coordinated Universal Time）标准使用原子钟的震荡来测量时间，确保更高的精度，UTC 是国际通用标准。

使用原子震荡周期及时的物理时钟也被称为原子钟（Automic Clock）。事实上在我们身边就有很多原子钟，例如，石英表、主板上的物理时钟。

由于地球自转减缓，UTC 引入了闰秒来保持与地球自转同步。这使得 UTC 的秒数可能会不规律地增加一秒，以确保与地球的实际自转同步。

### RTC

硬件时钟，Real Time Clock。由物理层面的主板上电池供电的时钟，该硬件时钟可以在 BIOS 中进行设置。

### 系统时钟

系统时钟，System Clock。Linux 内核中的时钟，当 Linux 系统启动时，根据硬件时钟和 /etc/adjtime 中的内容来计算系统时钟的初始值，启动完成后，系统时钟独立于硬件时钟运行。

## timedatectl
运行以下命令可以查看 Linux 系统内的时间设置。
```
timedatectl status
```

返回的结果如下所示能够查看本地时间（China Standard Time，中国标准时间 CST）、协调世界时、`RTC` 时间以及时区等信息。
```
Local time: Sun 2024-02-18 20:19:51 CST
Universal time: Sun 2024-02-18 12:19:51 UTC
RTC time: Sun 2024-02-18 12:19:51
Time zone: Asia/Shanghai (CST, +0800)
System clock synchronized: yes
NTP service: active
RTC in local TZ: no
```
# NTP

网络时间协议 `Network Time Protocol`，是 `TCP/IP` 协议族里面的一个应用层协议，用来使客户端和服务器之间进行时钟同步，提供高精度的时间矫正。`NTP` 使用 `UDP` 报文进行传输数据，使用的端口号为 `123`。 
## NTP 层级

NTP 允许客户端从服务器请求和接收时间，而服务器从权威时钟源（如原子钟、GPS）接收精确的协调世界时 UTC。

NTP 以层级来组织模型结构，层级中的每层被称为 `Stratum`。

通常将从权威时钟获得时钟同步的 NTP 服务器的层数设置为 `Stratum 1`，并将其作为主时间服务器，为网络中其他的设置提供时钟同步。

`Stratum 2` 则从 `Stratum 1` 获取时间，`Stratum 3` 从 `Stratum 2` 获取时间以此类推。

时钟层数的取值范围为 1~16，取值越小准确度越高。层数为 1~15 的时钟处于同步状态，层数为 16 的时钟被认为是未同步的，不能使用的。
![](NTP模型结构.png)
## NTP 同步原理

NTP 最典型的授时方式是 Client/Server 模式，如图。
![](NTP工作原理.png)
C/S 报文流程：
1. 客户端首先向服务端发送一个 NTP 报文，其中包含了该报文离开客户端的时间戳 `t1`。

2. NTP 请求报文到达 NTP 服务器，此时 NTP 服务器的时刻为 `t2`。当服务端接收到该报文时，NTP 服务器处理之后，于 `t3` 时刻发出 NTP 应答报文。该应答报文中携带 NTP 客户端的时间戳 `t1`、到达 NTP 服务器的时间戳 `t2` 和离开 NTP 服务器的时间戳 `t3`。

3. 客户端在接收到相应报文时，记录时间戳 `t4`。

客户端根据以上四个时间戳能够计算出两个关键参数：
**`delay`** NTP 报文从客户端到服务器的往返延迟。
	$delay = (t4 - t1) - (t3 - t2)$

**`offset`** 客户端于服务器端之间的时间差。
	$t2 = t1 + offset + delay/2$
	$t4 = t3 - offset + delay / 2$

NTP 客户端根据计算得到 `offset` 来调整自己得时钟，实现于 NTP 服务器的时钟同步。

NTP 客户端通常会选择多个同步服务器，并通过一定的算法来确定最准确的时间。这个算法被称为时钟选择算法，常见的算法包括最小平均偏差算法（MAD）和最小偏差算法（MD）等。

### 时钟选择算法 MAD

最小平均偏差算法，Minimum Average Deviation。
- 在MAD算法中，NTP客户端收集来自多个时间服务器的时间信息，并计算每个服务器时间与本地时钟的偏差。
- 对于每个服务器，客户端计算与本地时钟一段时间内的平均偏差，并选择具有最小平均偏差的服务器作为时间源。
- MAD算法的优势在于它考虑了一段时间内的平均偏差，而不仅仅是某一时刻的偏差。
### 时钟选择算法 MD

最小偏差算法，Minimum Deviation。
- 在MD算法中，NTP客户端同样收集来自多个时间服务器的时间信息，然后计算每个服务器时间与本地时钟的偏差。
- 与MAD算法不同的是，MD算法直接选择具有最小偏差的服务器作为时间源，而不是计算平均偏差。
- MD算法更加简单，因为它只关注当前时刻的偏差，而不考虑历史数据。

## NTP 实现

### NTPd

最常见的 NTP 实现之一，由 NTP 项目团队维护。

### Chrony

旨在提供更快速和精确的时间同步，相比于传统的 NTPd，Chrony在系统启动时能够更快地同步时间，并在网络不稳定时表现更为稳定。它也可以在断开网络连接后保持时间同步，适用于移动设备等场景。


# NTPd

# Chrony
